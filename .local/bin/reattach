#!/bin/sh

set -e
set -u

usage() {
    local exitcode out_fd
    case $# in
        0) exitcode=0; out_fd=1 ;;
        *) exitcode="$1"; out_fd=2; shift ;;
    esac
    echo "Usage: reattach [session name]" >&"$out_fd"
    exit "$exitcode"
}

while getopts "h" option; do
    case "$option" in
        h) usage ;;
        "?") usage 2 ;;
    esac
done
shift $(( $OPTIND - 1 ))
session_name="${1:-default}"

read screen_count detached_count screen_name <<EOF
$(screen -S "$session_name" -ls | awk '
BEGIN {c=0; d=0}
($5 ~ /\)$/) {c++}
($5 == "(Detached)") {d++; n=$1}
END {print c, d, n}
')
EOF
if [ "$detached_count" -gt 1 ]; then
    printf "error: %s detached screens named %s" "$detached_count" "$session_name"
    exit 3
elif [ "$detached_count" -eq 1 ]; then
    pkill -USR2 --parent "${screen_name%%.*}" 'sh$'
    exec screen -r "${screen_name:-$session_name}"
elif [ -d /run/systemd/system ]; then
    exec systemd-run \
         --user --scope --same-dir \
         --unit="screen-${session_name}-$(date --iso-8601=seconds)" \
         screen -S "$session_name"
else
    exec screen -S "$session_name"
fi
