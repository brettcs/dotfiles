#!/bin/sh

set -e

session_name="${1:-default}"
if [ "$session_name" != "${session_name#-}" ]; then
    echo "Usage: reattach [session name]"
    exit 0
fi

if ! [ -d /run/systemd/system ]; then
    exec screen -dR "$session_name"
fi

service_name="screen@${session_name}.service"
if systemctl --user --quiet is-active "$service_name"; then
    service_command=reload
else
    service_command=start
fi
systemctl --user "$service_command" "$service_name"

if [ -z "$SSH_CONNECTION" ]; then
    caption_arg=always
else
    caption_arg=splitonly
fi

sleep_time=.1
while ! screen -S "$session_name" -X caption "$caption_arg" 2>/dev/null; do
    sleep "$sleep_time"
    sleep_time=$(( "$sleep_time" * 2 ))
    if [ "$sleep_time" -ge 1 ]; then
        break
    fi
done

exec screen -r "$session_name"
